<div class="container-fluid">

        <div class="row-fluid">
            <div class="span12" style="text-align:right;">
                @Html.ActionLink("Sign Out", "SignOut")
            </div>
        </div>
        <div class="row-fluid">
            <div class="span2">
                <!--Sidebar content-->
                <div id="users_online">
                    <ul id="online"></ul>
                </div>
            </div>
            <div class="span10">
                <!--Body content-->

                <div id="livechat" class="well" style="min-height:460px;">
                    <ul id="discussion">
                        @foreach (CJChat.Models.ChatMessage message in CJChat.Classes.MessageStore.Messages.OrderBy(x => x.TimeStamp))
                {
                    <li><strong>@message.UserName </strong>: @message.Message <span class="timestamp">@message.TimeStamp.ToString("g")</span></li>
        }
                    </ul>
                </div>

            </div>


        </div>
    </div>

<div class="navbar navbar-fixed-bottom">
    <div class="navbar-inner">
        <div class="container">
            <a class="brand"></a>
            <form class="navbar-form">
                <input type="hidden" id="displayname" value="@Session["UserName"]" style="margin-bottom: 3px;" />
                <input class="span8" type="text" id="message" placeholder="Be nice" style="margin-bottom: 3px;" />
                <input class="btn btn-primary span2" type="button" id="send" value="Send" />
            </form>
        </div>
    </div>
</div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            chat.client.addMessage = function (name, message, timestamp) {
                // Add the message to the page.
                $('#discussion').append('<li><strong>' + htmlEncode(name)
                    + '</strong>: ' + htmlEncode(message) + ' <span class="timestamp">' + timestamp + '</span></li>'); 
            };
            // Create a function to update the online users list
            chat.client.updateUsers = function (data) {
                if (data != null) {
                    $('#online').html("");
                    for (var index = 0; index < data.length; index++) {
                        //add the user to the list of online users
                        $('#online').append("<li>" + data[index] + "</li>");
                    }
                }
            };
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                chat.server.addUser($('#displayname').val());
                $('#send').click(function () {
                    send(chat);
                });
                //handle enter key event on messagebox
                $("#message").keydown(function (e) {
                    if (e.which === 13) {
                        send(chat);
                        return false;
                    }
                });
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
        function send(chat) {
            // Call the Send method on the hub.
            chat.server.send($('#displayname').val(), $('#message').val());
            // Clear text box and reset focus for next comment.
            $('#message').val('').focus();
        }
    </script>
}